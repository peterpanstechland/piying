# 动捕系统测试指南

## 修复内容

### 1. 移除镜像翻转
- **修改前**: `const dx = (1 - endLm.x) - (1 - startLm.x)` （镜像翻转）
- **修改后**: `const dx = endLm.x - startLm.x` （使用原始坐标）

### 2. 正确使用 rest_pose_offset
- **新公式**: `sprite.rotation = mediaPipeAngle - restPoseOffset + rotationOffset`
- **说明**:
  - `mediaPipeAngle`: MediaPipe 检测到的当前角度
  - `restPoseOffset`: 默认姿势下该部件的角度（基准）
  - `rotationOffset`: 素材本身的朝向偏移

## 测试步骤

### 准备工作
1. 重启后端服务
2. 刷新前端页面
3. 进入"摄像头测试"页面

### 测试场景

#### 场景 1: 手臂自然下垂
**预期结果**: 皮影手臂也应该自然下垂

**操作**:
1. 站在摄像头前，双手自然下垂
2. 观察皮影手臂位置

**判断标准**:
- ✅ 皮影手臂垂直向下或略微向前
- ❌ 皮影手臂举高或向后

#### 场景 2: 双手举高
**预期结果**: 皮影手臂也应该举高

**操作**:
1. 双手向上举起（如投降姿势）
2. 观察皮影手臂位置

**判断标准**:
- ✅ 皮影手臂向上举起
- ❌ 皮影手臂向下或保持不动

#### 场景 3: 单手侧平举
**预期结果**: 皮影对应手臂水平伸出

**操作**:
1. 左手或右手水平侧平举
2. 观察皮影手臂位置

**判断标准**:
- ✅ 皮影手臂水平伸出
- ❌ 皮影手臂角度不对

#### 场景 4: 手臂前伸
**预期结果**: 皮影手臂向前伸出

**操作**:
1. 双手向前伸直（如推东西）
2. 观察皮影手臂位置

**判断标准**:
- ✅ 皮影手臂向前伸出
- ❌ 皮影手臂向后或其他方向

### 调试工具

#### 1. 显示骨骼
- 勾选"显示骨骼"选项
- 查看 MediaPipe 检测的关键点和连线
- 确认检测准确

#### 2. 调试面板
- 勾选"调试面板"选项
- 查看关键点坐标和可见度
- 确认数据正常

#### 3. 控制台日志
- 打开浏览器开发者工具
- 查看 Console 标签
- 每 60 帧会输出一次详细日志：
  ```
  left-arm: MP=45.0° rest=90.0° rot=0.0° final=-45.0°
  ```
  - MP: MediaPipe 检测角度
  - rest: 默认姿势角度
  - rot: 素材朝向偏移
  - final: 最终旋转角度

## 常见问题

### Q1: 手臂方向还是相反
**可能原因**:
1. `rest_pose_offset` 没有正确设置
2. 素材朝向与配置不匹配

**解决方法**:
1. 进入"默认姿势"编辑器
2. 调整手臂角度到自然下垂
3. 保存配置

### Q2: 手臂角度不自然
**可能原因**:
1. `rotation_offset` 设置不正确
2. 素材本身绘制方向有问题

**解决方法**:
1. 进入"枢轴配置"
2. 检查"旋转偏移量"设置
3. 调整到正确的素材朝向

### Q3: 手臂抖动
**可能原因**:
1. MediaPipe 检测不稳定
2. 光线条件不好

**解决方法**:
1. 改善光线条件
2. 调整摄像头位置
3. 保持身体稳定

## 下一步优化

### 1. 添加平滑滤波
- 对角度变化进行平滑处理
- 减少抖动

### 2. 添加预测
- 使用卡尔曼滤波预测下一帧
- 提高响应速度

### 3. 优化旋转限制
- 为每个部件设置合理的旋转范围
- 防止不自然的动作

### 4. 支持更多部件
- 腿部动作捕捉
- 身体倾斜
- 头部转动
